<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GraphDB RBAC - WebAuthn Registration Demo</title>
    <script type="module">
        // Import GraphDB and RBAC module from CDN
        // Ensure these URLs are up-to-date if needed.
        import { GraphDB } from "https://cdn.jsdelivr.net/npm/gdb-p2p/+esm";
        import * as rbac from "https://cdn.jsdelivr.net/npm/gdb-p2p/dist/rbac.min.js/+esm";
        
        // Make them globally accessible for easier interaction in this simple demo
        window.GraphDB = GraphDB;
        window.rbac = rbac;
    </script>
    <style>
        body { 
            font-family: Arial, sans-serif; 
            margin: 20px; 
            background-color: #f0f2f5; 
            color: #333;
            display: flex;
            flex-direction: column;
            align-items: center;
        }
        .container {
            background-color: #fff;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            width: 100%;
            max-width: 500px;
        }
        h1 { 
            color: #1a73e8; 
            text-align: center;
        }
        button { 
            background-color: #1a73e8; 
            color: white; 
            border: none; 
            padding: 10px 15px; 
            margin: 10px 0; 
            border-radius: 5px; 
            cursor: pointer; 
            font-size: 16px;
            display: block; /* Make buttons take full width */
            width: 100%;
        }
        button:hover { 
            background-color: #1558b0; 
        }
        button:disabled {
            background-color: #ccc;
            cursor: not-allowed;
        }
        .info, .status { 
            margin-top: 15px; 
            padding: 10px; 
            border: 1px solid #ddd; 
            border-radius: 5px; 
            background-color: #e9ecef;
        }
        .info code {
            background-color: #d4d4d4;
            padding: 2px 4px;
            border-radius: 3px;
            word-break: break-all;
        }
        .warning {
            color: #d93025;
            font-weight: bold;
            background-color: #fddede;
            padding: 10px;
            border-radius: 5px;
            margin-top: 10px;
        }
        .hidden {
            display: none;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>WebAuthn Registration Demo</h1>
        <p>This demo shows how to generate a new identity and protect it using WebAuthn with the GDB RBAC module.</p>

        <!-- Step 1: Generate Identity -->
        <button id="btnGenerateIdentity">1. Generate New ETH Identity</button>
        
        <div id="identityDetails" class="info hidden">
            <p><strong>New Ethereum Address:</strong> <code id="ethAddress"></code></p>
            <p><strong>Your Mnemonic Phrase:</strong> <code id="mnemonicPhrase"></code></p>
            <div class="warning">
                ⚠️ IMPORTANT: Securely save this Mnemonic Phrase! It's your backup if WebAuthn fails or you change devices.
            </div>
        </div>

        <!-- Step 2: Protect with WebAuthn -->
        <button id="btnProtectWebAuthn" disabled>2. Protect Current Identity with WebAuthn</button>

        <!-- Status Area -->
        <div id="statusArea" class="status">
            Status: Awaiting initialization...
        </div>
    </div>

    <script type="module">
        // Get references to DOM elements
        const btnGenerateIdentity = document.getElementById('btnGenerateIdentity');
        const identityDetailsDiv = document.getElementById('identityDetails');
        const ethAddressElem = document.getElementById('ethAddress');
        const mnemonicPhraseElem = document.getElementById('mnemonicPhrase');
        const btnProtectWebAuthn = document.getElementById('btnProtectWebAuthn');
        const statusArea = document.getElementById('statusArea');

        let db;
        let volatileIdentity = null; // To store { address, mnemonic, privateKey } from startNewUserRegistration

        // Function to update status messages
        function updateStatus(message, isError = false) {
            statusArea.textContent = `Status: ${message}`;
            statusArea.style.color = isError ? '#d93025' : '#333';
            statusArea.style.backgroundColor = isError ? '#fddede' : '#e9ecef';
            console.log(message);
        }

        // Initialize the GraphDB and RBAC security context
        async function initializeApp() {
            if (!window.GraphDB || !window.rbac) {
                updateStatus("GraphDB or RBAC library not loaded.", true);
                return;
            }
            
            try {
                updateStatus("Initializing GraphDB...");
                db = new window.GraphDB("webAuthnDemoDB"); // Create a GDB instance
                await db.ready; // Wait for DB to be ready
                updateStatus("GraphDB ready. Initializing RBAC Security Context...");

                // Initialize the RBAC security context for the GDB instance.
                // No superAdmins needed for this basic demo.
                await window.rbac.createSecurityContext(db); 
                updateStatus("RBAC Security Context Initialized. Ready to generate identity.");

                // Set a callback for security state changes (optional for this simple demo, but good practice)
                window.rbac.setSecurityStateChangeCallback(securityState => {
                    if (securityState) {
                        console.log("Security state changed:", securityState);
                        // Example: Update UI if WebAuthn becomes available/unavailable
                        if (securityState.hasWebAuthnHardwareRegistration) {
                            console.log("WebAuthn hardware/browser support detected.");
                        }
                         // If a user is logged in (e.g. after WebAuthn registration),
                         // you might disable registration buttons.
                        if (securityState.isActive) {
                            btnGenerateIdentity.disabled = true;
                            btnProtectWebAuthn.disabled = true;
                            updateStatus(`Session active for ${securityState.activeAddress}. Refresh to register new identity.`);
                        } else {
                            btnGenerateIdentity.disabled = false;
                        }
                    }
                });

            } catch (error) {
                updateStatus(`Initialization Error: ${error.message}`, true);
                console.error("Initialization failed:", error);
            }
        }

        // Event listener for "Generate New ETH Identity" button
        btnGenerateIdentity.addEventListener('click', async () => {
            try {
                updateStatus("Generating new identity...");
                // Clears any previous security session and generates a new ETH identity in memory
                volatileIdentity = await window.rbac.startNewUserRegistration(); 
                
                if (volatileIdentity) {
                    ethAddressElem.textContent = volatileIdentity.address;
                    mnemonicPhraseElem.textContent = volatileIdentity.mnemonic;
                    identityDetailsDiv.classList.remove('hidden');
                    
                    btnProtectWebAuthn.disabled = false; // Enable the next step
                    updateStatus("New identity generated. SAVE YOUR MNEMONIC and proceed to WebAuthn protection.");
                } else {
                    updateStatus("Failed to generate new identity.", true);
                }
            } catch (error) {
                updateStatus(`Error generating identity: ${error.message}`, true);
                console.error("Error in startNewUserRegistration:", error);
            }
        });

        // Event listener for "Protect Current Identity with WebAuthn" button
        btnProtectWebAuthn.addEventListener('click', async () => {
            if (!volatileIdentity || !volatileIdentity.privateKey) {
                updateStatus("No identity generated or private key missing. Please generate an identity first.", true);
                return;
            }

            try {
                updateStatus("Starting WebAuthn registration... Follow browser prompts.");
                // Protects the private key from volatileIdentity using WebAuthn
                // and activates a session with this identity.
                const protectedAddress = await window.rbac.protectCurrentIdentityWithWebAuthn(volatileIdentity.privateKey); 
                
                if (protectedAddress) {
                    updateStatus(`Successfully protected identity for ${protectedAddress} with WebAuthn! Session is now active.`);
                    btnProtectWebAuthn.disabled = true; // Optionally disable after successful registration
                    btnGenerateIdentity.disabled = true; // User is now "logged in"
                    volatileIdentity = null; // Clear the temporary identity from memory
                } else {
                    updateStatus("WebAuthn protection failed. User may have cancelled or an error occurred. Check browser console.", true);
                }
            } catch (error) {
                updateStatus(`WebAuthn protection error: ${error.message}. Ensure HTTPS/localhost and browser support.`, true);
                console.error("Error in protectCurrentIdentityWithWebAuthn:", error);
            }
        });

        // Start the application initialization
        initializeApp();
    </script>
</body>
</html>