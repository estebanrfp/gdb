<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GenosDB - Test de Estrategias de Fusión</title>
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; margin: 0; background-color: #f4f7f9; color: #333; line-height: 1.6; }
        .container { max-width: 900px; margin: 20px auto; padding: 20px; background: #fff; border-radius: 8px; box-shadow: 0 4px 12px rgba(0,0,0,0.1); }
        h1, h2 { color: #1a2b4d; text-align: center; border-bottom: 2px solid #e9eff5; padding-bottom: 10px; }
        h2 { font-size: 1.5em; border-bottom: none; }
        .controls { display: flex; justify-content: space-between; align-items: center; padding: 15px; background: #e9eff5; border-radius: 6px; margin-bottom: 20px; flex-wrap: wrap; gap: 10px; }
        .controls div { display: flex; align-items: center; gap: 10px; }
        .controls select, .controls button { padding: 10px 15px; border: 1px solid #ccc; border-radius: 5px; font-size: 16px; cursor: pointer; background-color: #fff; }
        .controls button { background-color: #007bff; color: white; border: none; transition: background-color 0.2s; }
        .controls button:hover { background-color: #0056b3; }
        .controls #clear-db { background-color: #dc3545; }
        .controls #clear-db:hover { background-color: #c82333; }
        #tasks-list { list-style: none; padding: 0; }
        .task-item { display: flex; justify-content: space-between; align-items: flex-start; padding: 15px; border-bottom: 1px solid #e0e0e0; transition: background-color 0.3s; gap: 15px;}
        .task-item:last-child { border-bottom: none; }
        .task-item:hover { background-color: #fafafa; }
        .task-content { flex-grow: 1; }
        .task-content strong { display: block; margin-bottom: 8px; font-size: 1.1em; color: #1a2b4d; }
        .task-content pre { background: #eee; padding: 10px; border-radius: 4px; font-family: "SF Mono", "Courier New", monospace; white-space: pre-wrap; word-wrap: break-word; font-size: 0.9em; margin-top: 8px; border: 1px solid #ddd; }
        .task-actions { display: flex; flex-direction: column; gap: 8px; flex-shrink: 0; }
        .task-actions button { width: 100%; padding: 8px 12px; font-size: 14px; border: 1px solid #ccc; background-color: #f8f9fa; color: #333; }
        .task-actions button:hover { border-color: #888; background-color: #e9ecef;}
    </style>
</head>
<body>
    <div class="container">
        <h1>⚡ GenosDB: Test de Estrategias de Fusión</h1>
        <div class="controls">
            <div>
                <label for="strategy-select">Estrategia de Fusión:</label>
                <select id="strategy-select">
                    <option value="merge">merge (Shallow Merge)</option>
                    <option value="overwrite">overwrite (Reemplazo Total)</option>
                </select>
            </div>
            <button id="add-task">Añadir Tarea de Prueba</button>
            <button id="clear-db">Limpiar Base de Datos</button>
        </div>
        <h2>Tareas Pendientes (Sincronizadas en tiempo real)</h2>
        <ul id="tasks-list">
            <!-- Las tareas se renderizarán aquí -->
        </ul>
    </div>

    <script type="module">
        // Importación de la librería
        import { GDB } from "https://cdn.jsdelivr.net/npm/genosdb/+esm";

        // --- Constantes y Variables Globales ---
        const dbName = "gdb-final-strategy-test";
        const storageKey = "gdb-test-strategy"; // Clave para localStorage
        const strategySelect = document.getElementById('strategy-select');
        const tasksList = document.getElementById('tasks-list');
        let db;
        let unsubscribe;

        // --- Funciones Principales ---

        async function initializeDB(strategy) {
            console.log(`Inicializando DB con la estrategia: ${strategy}`);
            
            if (unsubscribe) {
                unsubscribe();
                unsubscribe = null;
            }
            
            tasksList.innerHTML = '';

            db = new GDB(dbName, { 
                mergeStrategy: strategy 
            });

            const { unsubscribe: newUnsubscribe } = await db.map({
                query: { type: 'task' }
            }, renderTask);
            unsubscribe = newUnsubscribe;
        }

        function renderTask({ id, value, action }) {
            const existingLi = document.getElementById(id);

            if (action === 'removed') {
                if (existingLi) existingLi.remove();
                return;
            }

            if (!value) return;

            const li = existingLi || document.createElement('li');
            li.id = id;
            li.className = 'task-item';

            li.innerHTML = `
                <div class="task-content">
                    <strong>${value.title || 'Sin título'}</strong>
                    <pre>${JSON.stringify(value, null, 2)}</pre>
                </div>
                <div class="task-actions">
                    <button class="update-title-btn" data-id="${id}">Actualizar Título (Pestaña A)</button>
                    <button class="add-details-btn" data-id="${id}">Añadir Detalles (Pestaña B)</button>
                    <button class="delete-btn" data-id="${id}">Eliminar</button>
                </div>
            `;

            if (!existingLi) {
                tasksList.prepend(li);
            }
        }
        
        // --- Manejadores de Eventos de la UI ---
        
        strategySelect.addEventListener('change', (e) => {
            const newStrategy = e.target.value;
            // ▼▼▼ CAMBIO: Guardar la nueva estrategia en localStorage ▼▼▼
            localStorage.setItem(storageKey, newStrategy);
            initializeDB(newStrategy);
        });
        
        document.getElementById('add-task').addEventListener('click', async () => {
            const taskId = 'task-' + Date.now();
            await db.put({
                type: 'task',
                title: `Nueva Tarea ${new Date().toLocaleTimeString()}`,
                status: 'pending',
                createdAt: new Date().toISOString()
            }, taskId);
        });

        document.getElementById('clear-db').addEventListener('click', async () => {
            await db.clear();
        });

        tasksList.addEventListener('click', async (e) => {
            const target = e.target;
            // Optimización: Usamos .closest para encontrar el botón aunque se haga clic en su texto interno
            const button = target.closest('button[data-id]');
            if (!button) return;
            
            const id = button.dataset.id;
            const { result: node } = await db.get(id);
            if (!node) return;

            if (button.classList.contains('delete-btn')) {
                await db.remove(id);
            }
            
            if (button.classList.contains('update-title-btn')) {
                await db.put({
                    ...node.value,
                    title: `Título actualizado @ ${new Date().toLocaleTimeString()}`
                }, id);
            }

            if (button.classList.contains('add-details-btn')) {
                await db.put({
                    ...node.value,
                    details: {
                        priority: 'high',
                        assignee: 'user-' + Math.floor(Math.random() * 10)
                    }
                }, id);
            }
        });

        // --- Bloque de Inicialización de la Aplicación ---

        // ▼▼▼ CAMBIO: Función para cargar y aplicar la estrategia guardada ▼▼▼
        function loadAndInitialize() {
            // Intentamos obtener la estrategia guardada; si no existe, usamos 'merge' por defecto.
            const savedStrategy = localStorage.getItem(storageKey) || 'merge';
            
            // Actualizamos el valor del <select> para que refleje la estrategia activa.
            strategySelect.value = savedStrategy;
            
            // Inicializamos la base de datos con esa estrategia.
            initializeDB(savedStrategy);
        }

        // Llamamos a la función de inicialización cuando el script se carga.
        loadAndInitialize();

    </script>
</body>
</html>