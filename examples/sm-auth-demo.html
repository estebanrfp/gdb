<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GDB Secure Notes (Improved UX)</title>
    <style>
        :root {
            --bg-color: #f8f9fa;
            --text-color: #212529;
            --primary-color: #007bff;
            --primary-hover: #0056b3;
            --border-color: #dee2e6;
            --warning-bg: #fff3cd;
            --warning-text: #856404;
            --success-bg: #d4edda;
            --success-text: #155724;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            background-color: var(--bg-color);
            color: var(--text-color);
            margin: 0;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            text-align: center;
        }

        main {
            width: 100%;
            max-width: 420px;
            padding: 2rem;
            box-sizing: border-box;
        }

        .view {
            display: flex;
            flex-direction: column;
            gap: 1rem;
            width: 100%;
        }

        h1 {
            font-weight: 600;
            margin-bottom: 1rem;
        }

        .hidden {
            display: none !important;
        }

        /* Login View */
        textarea {
            width: 100%;
            height: 80px;
            padding: 0.75rem;
            border: 1px solid var(--border-color);
            border-radius: 8px;
            font-size: 1rem;
            font-family: monospace;
            resize: none;
            box-sizing: border-box;
            line-height: 1.5;
            background-color: #fff;
        }

        textarea:read-only {
            background-color: #e9ecef;
            /* Visual cue that it's read-only */
        }

        .button-group {
            display: flex;
            flex-direction: column;
            gap: 0.75rem;
        }

        button {
            width: 100%;
            padding: 0.8rem 1rem;
            font-size: 1rem;
            font-weight: 500;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            transition: background-color 0.2s;
            background-color: var(--primary-color);
            color: white;
        }

        button:hover {
            background-color: var(--primary-hover);
        }

        button.secondary {
            background-color: #6c757d;
        }

        button.secondary:hover {
            background-color: #5a6268;
        }

        .warning-message {
            background-color: var(--warning-bg);
            color: var(--warning-text);
            padding: 1rem;
            border-radius: 8px;
            font-size: 0.9rem;
            border: 1px solid #ffeeba;
        }

        /* App View */
        .status-bar {
            font-size: 0.9rem;
            color: #6c757d;
            word-break: break-all;
            margin-bottom: 1rem;
        }

        .note-container {
            width: 100%;
            display: flex;
            flex-direction: column;
            gap: 0.75rem;
        }

        .note-container input {
            width: 100%;
            padding: 0.75rem;
            border: 1px solid var(--border-color);
            border-radius: 8px;
            font-size: 1rem;
            box-sizing: border-box;
        }

        .note-display {
            min-height: 50px;
            padding: 1rem;
            background-color: white;
            border: 1px solid var(--border-color);
            border-radius: 8px;
            text-align: left;
            word-wrap: break-word;
        }

        .note-display.success {
            background-color: var(--success-bg);
            color: var(--success-text);
        }
    </style>
</head>

<body>

    <main>
        <!-- LOGIN / REGISTRATION VIEW -->
        <div id="login-view" class="view">
            <h1>Secure Notes</h1>
            <p>Generate an identity or log in with your mnemonic phrase.</p>

            <textarea id="mnemonic-area"
                placeholder="Enter your 12-word recovery phrase here to log in, or generate a new one."></textarea>

            <div id="warning-message" class="warning-message hidden">
                <strong>SAVE THIS PHRASE!</strong> This is your only way to recover your account. Store it securely in a
                password manager.
            </div>

            <div class="button-group">
                <button id="copy-phrase-btn" class="secondary hidden">Copy Phrase</button>
                <button id="generate-btn">Generate New Identity</button>
                <button id="mnemonic-login-btn">Login with Mnemonic</button>
                <button id="webauthn-login-btn" class="secondary hidden">Login with Passkey</button>
                <button id="protect-passkey-btn" class="hidden">Protect with Passkey (Recommended)</button>
            </div>
        </div>

        <!-- LOGGED-IN APPLICATION VIEW -->
        <div id="app-view" class="view hidden">
            <h1>Your Secure Note</h1>
            <div class="status-bar">
                Logged in as: <span id="user-address"></span>
            </div>

            <div class="note-container">
                <input type="text" id="note-id-input" placeholder="Note title (ID)...">
                <input type="text" id="note-input" placeholder="Type your secret note content...">
                <button id="save-note-btn">Save Encrypted Note</button>
                <button id="load-note-btn" class="secondary">Load Encrypted Note</button>
            </div>

            <div id="note-display" class="note-display">
                Your decrypted note will appear here.
            </div>

            <button id="logout-btn" class="secondary">Logout</button>
        </div>
    </main>

    <script type="module">
        import { gdb } from "../dist/index.js";

        // --- DOM Elements ---
        const loginView = document.getElementById('login-view');
        const appView = document.getElementById('app-view');
        const mnemonicArea = document.getElementById('mnemonic-area');
        const warningMessage = document.getElementById('warning-message');
        const generateBtn = document.getElementById('generate-btn');
        const mnemonicLoginBtn = document.getElementById('mnemonic-login-btn');
        const webauthnLoginBtn = document.getElementById('webauthn-login-btn');
        const protectPasskeyBtn = document.getElementById('protect-passkey-btn');
        const copyPhraseBtn = document.getElementById('copy-phrase-btn'); // NEW
        const userAddressSpan = document.getElementById('user-address');
        const noteIdInput = document.getElementById('note-id-input');
        const noteInput = document.getElementById('note-input');
        const saveNoteBtn = document.getElementById('save-note-btn');
        const loadNoteBtn = document.getElementById('load-note-btn');
        const noteDisplay = document.getElementById('note-display');
        const logoutBtn = document.getElementById('logout-btn');

        // Note ID is provided by the user via the UI (note title)

        async function main() {
            const db = await gdb("secure-notes-db-v2", {
                rtc: true,
                sm: {
                    superAdmins: ["0x0000000000000000000000000000000000000000"]
                }
            });
            window.db = db;

            function updateUI(state) {
                loginView.classList.toggle('hidden', state.isActive);
                appView.classList.toggle('hidden', !state.isActive);

                if (state.isActive) {
                    userAddressSpan.textContent = state.activeAddress;
                    noteIdInput.value = '';
                    noteInput.value = '';
                    noteDisplay.textContent = 'Load your note to see its content.';
                    noteDisplay.classList.remove('success');
                }
                else {
                    const inRegistrationFlow = state.hasVolatileIdentity;

                    // --- NEW UX LOGIC ---
                    // Make textarea read-only during registration to prevent accidental edits.
                    mnemonicArea.readOnly = inRegistrationFlow;
                    // Hide the generate button during registration to avoid confusion.
                    generateBtn.classList.toggle('hidden', inRegistrationFlow);
                    // Show the dedicated copy button only during registration.
                    copyPhraseBtn.classList.toggle('hidden', !inRegistrationFlow);

                    // --- EXISTING UX LOGIC ---
                    webauthnLoginBtn.classList.toggle('hidden', !state.hasWebAuthnHardwareRegistration);
                    warningMessage.classList.toggle('hidden', !inRegistrationFlow);
                    protectPasskeyBtn.classList.toggle('hidden', !inRegistrationFlow);
                    mnemonicLoginBtn.classList.toggle('hidden', false); // Always visible when logged out.

                    if (!inRegistrationFlow) {
                        mnemonicArea.value = '';
                        mnemonicArea.placeholder = "Enter your 12-word recovery phrase here..."
                    }
                }
            }

            generateBtn.addEventListener('click', async () => {
                try {
                    const newIdentity = await db.sm.startNewUserRegistration();
                    if (newIdentity) {
                        mnemonicArea.value = newIdentity.mnemonic;
                    }
                } catch (e) { alert(`Error generating identity: ${e.message}`); }
            });

            // NEW: One-click copy listener
            copyPhraseBtn.addEventListener('click', () => {
                navigator.clipboard.writeText(mnemonicArea.value).then(() => {
                    copyPhraseBtn.textContent = 'Copied!';
                    setTimeout(() => { copyPhraseBtn.textContent = 'Copy Phrase'; }, 2000);
                }).catch(err => {
                    console.error('Failed to copy text: ', err);
                    alert('Could not copy phrase. Please copy it manually.');
                });
            });

            mnemonicLoginBtn.addEventListener('click', async () => {
                const mnemonic = mnemonicArea.value.trim();
                if (mnemonic.split(' ').length !== 12) {
                    alert('Please enter a valid 12-word mnemonic phrase.');
                    return;
                }
                try { await db.sm.loginOrRecoverUserWithMnemonic(mnemonic); }
                catch (e) { alert(`Login failed: ${e.message}`); }
            });

            webauthnLoginBtn.addEventListener('click', async () => {
                try { await db.sm.loginCurrentUserWithWebAuthn(); }
                catch (e) { if (e.name !== 'NotAllowedError') { alert(`Passkey login failed: ${e.message}`); } }
            });

            protectPasskeyBtn.addEventListener('click', async () => {
                try {
                    const address = await db.sm.protectCurrentIdentityWithWebAuthn();
                    if (address) { alert(`Account protected with Passkey for address: ${address}`); }
                } catch (e) { if (e.name !== 'NotAllowedError') { alert(`Could not protect with Passkey: ${e.message}`); } }
            });

            logoutBtn.addEventListener('click', async () => {
                await db.sm.clearSecurity();
            });

            saveNoteBtn.addEventListener('click', async () => {
                const id = noteIdInput.value.trim();
                const noteContent = noteInput.value.trim();
                if (!id) { alert('Please enter a note title (ID).'); return; }
                if (!noteContent) { alert('Please enter note content.'); return; }
                try {
                    await db.sm.put({ content: noteContent }, id);
                    noteDisplay.textContent = 'Note saved and encrypted successfully!';
                    noteDisplay.classList.add('success');
                } catch (e) { alert(`Error saving note: ${e.message}`); }
            });

            loadNoteBtn.addEventListener('click', async () => {
                const id = noteIdInput.value.trim();
                if (!id) { alert('Please enter a note title (ID) to load.'); return; }
                try {
                    const { result: node } = await db.sm.get(id);
                    if (node && node.decrypted) {
                        noteDisplay.textContent = `Decrypted Note: ${node.value.content}`;
                        noteDisplay.classList.add('success');
                    } else if (node) {
                        noteDisplay.textContent = 'Could not decrypt note. You might not be the owner.';
                        noteDisplay.classList.remove('success');
                    } else {
                        noteDisplay.textContent = 'No note found. Save one first!';
                        noteDisplay.classList.remove('success');
                    }
                } catch (e) { alert(`Error loading note: ${e.message}`); }
            });

            db.sm.setSecurityStateChangeCallback(updateUI);
        }

        main().catch(console.error);
    </script>
</body>

</html>