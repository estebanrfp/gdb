<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GenosDB - `$edge` Operator Testbed</title>
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; margin: 0; background-color: #f4f7f9; color: #333; display: flex; justify-content: center; align-items: center; min-height: 100vh; }
        .panel { background-color: white; border-radius: 8px; padding: 30px; box-shadow: 0 4px 20px rgba(0,0,0,0.1); max-width: 800px; width: 100%; }
        h1, h2 { color: #1a253c; border-bottom: 2px solid #eef2f5; padding-bottom: 10px; }
        button { width: 100%; padding: 15px; margin-bottom: 10px; border-radius: 5px; border: 1px solid #ccc; background-color: #e9ecef; color: #333; font-weight: bold; font-size: 16px; cursor: pointer; transition: background-color 0.2s, border-color 0.2s; text-align: left; }
        button:hover { background-color: #dde; border-color: #bbb; }
        button span { font-weight: normal; font-size: 0.9em; color: #666; display: block; margin-top: 5px; }
        pre { background-color: #eef2f5; padding: 15px; border-radius: 5px; white-space: pre-wrap; word-wrap: break-word; font-family: "Courier New", Courier, monospace; line-height: 1.5; }
        #log { max-height: 150px; overflow-y: auto; font-size: 0.9em; }
        .instructions { background-color: #d4edda; border-left: 4px solid #155724; padding: 10px 15px; margin-bottom: 20px;}
    </style>
</head>
<body>

    <div class="panel">
        <h1>âœ… GenosDB - `$edge` Operator Testbed</h1>
        <div class="instructions">
            <strong>Open the Developer Console (F12)</strong> to see the results of each test.
        </div>
        
        <h2>Test Scenarios:</h2>
        
        <button id="test1">
            Test 1: Get ALL Person Descendants
            <span>Should find all 4 people in the Perez family tree (Juan, Maria, Pedro, Ana).</span>
        </button>

        <button id="test2">
            Test 2: Get ADULT Descendants
            <span>Uses `{ age: { $gt: 18 } }`. Should find only Juan and Maria.</span>
        </button>

        <button id="test3">
            Test 3: Get Descendants with OR
            <span>Uses `{ $or: [...] }`. Should find only Pedro and Ana.</span>
        </button>
        
        <button id="test4">
            Test 4: Get Descendants of a specific child (Juan)
            <span>Starts the search from 'Juan'. Should find only Pedro.</span>
        </button>
        
        <button id="test5">
            Test 5: No Matching Descendants
            <span>Searches for `{ type: 'Pet' }`. Should find 0 results.</span>
        </button>

        <h2>Setup Log:</h2>
        <pre id="log"></pre>
    </div>

    <script type="module">
        import { GDB } from "../dist/index.js";
        const db = new GDB('final-edge-test-db-v3');

        const logEl = document.getElementById('log');
        function logMessage(message) {
            logEl.innerHTML += `> ${message}\n`;
            logEl.scrollTop = logEl.scrollHeight;
        }

        async function runTest(testName, query) {
            console.clear();
            console.log(`%c--- RUNNING: ${testName} ---`, 'color: blue; font-size: 1.2em; font-weight: bold;');
            console.log("Query Object:", query);

            logMessage(`Running: ${testName}...`);
            const startTime = performance.now();
            const { results } = await db.map({ query });
            const endTime = performance.now();
            const duration = (endTime - startTime).toFixed(2);
            
            console.log(`%c--- RESULTS ---`, 'color: green; font-size: 1.2em; font-weight: bold;');
            console.log(`Execution Time: ${duration} ms`);
            console.log(`Found ${results.length} item(s).`);
            console.log(results);
            logMessage(`Finished: ${testName}. Found ${results.length} items. Check console.`);
        }

        async function setupScenario() {
            await db.clear();
            logMessage("Database cleared.");
            
            // Create Nodes
            const familyId = await db.put({ type: 'Family', name: 'Perez' });
            const juanId = await db.put({ type: 'Person', name: 'Juan', age: 40 });
            const mariaId = await db.put({ type: 'Person', name: 'Maria', age: 38 });
            const pedroId = await db.put({ type: 'Person', name: 'Pedro', age: 15 });
            const anaId = await db.put({ type: 'Person', name: 'Ana', age: 12 });
            logMessage("Nodes created: Perez Family, Juan, Maria, Pedro, Ana.");

            // Create Links
            await db.link(familyId, juanId);
            await db.link(familyId, mariaId);
            await db.link(juanId, pedroId); // Juan is Pedro's parent
            await db.link(mariaId, anaId);   // Maria is Ana's parent
            logMessage("Family tree links created.");
            logMessage("Scenario ready. Click a test to run.");
        }

        async function init() {
            await setupScenario();

            document.getElementById('test1').addEventListener('click', () => runTest(
                "Get ALL Person Descendants",
                { type: 'Family', name: 'Perez', $edge: { type: 'Person' } }
            ));

            document.getElementById('test2').addEventListener('click', () => runTest(
                "Get ADULT Descendants",
                { type: 'Family', name: 'Perez', $edge: { type: 'Person', age: { $gt: 18 } } }
            ));

            document.getElementById('test3').addEventListener('click', () => runTest(
                "Get Descendants with OR",
                { type: 'Family', name: 'Perez', $edge: { $or: [{ name: 'Pedro' }, { name: 'Ana' }] } }
            ));

            document.getElementById('test4').addEventListener('click', () => runTest(
                "Get Descendants of a specific child (Juan)",
                { type: 'Person', name: 'Juan', $edge: { type: 'Person' } }
            ));

            document.getElementById('test5').addEventListener('click', () => runTest(
                "No Matching Descendants",
                { type: 'Family', name: 'Perez', $edge: { type: 'Pet' } }
            ));
        }
        
        init();

    </script>
</body>
</html>