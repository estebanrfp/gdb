<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Real-Time Geolocation</title>
  <!-- Leaflet CSS -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 20px;
    }

    #map {
      width: 100%;
      height: 400px;
      border: 1px solid #ccc;
      margin-top: 20px;
    }

    #results {
      margin-top: 20px;
    }
  </style>
</head>

<body>
  <h1>Real-Time Location Detection</h1>
  <p>Your current location will update automatically and nearby nodes will be displayed.</p>

  <div id="status">Searching for location...</div>
  <div id="current-location"></div>

  <div id="map"></div>
  <div id="results"></div>

  <!-- Leaflet JS -->
  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
  <script type="module">
    // Import gdb and geolocation operators
    import { gdb } from "../dist/index.js";

    // Create a gdb instance with geolocation operators
    const db = await gdb("geolocationDB", { rtc: true, geo: true });

    // db.clear()

    // Simulate some nodes with geographic coordinates
    async function populateSampleData() {
      // await db.put({ latitude: 34.53264501340196, longitude: -0.4273969105505087, name: "Node A" });
      // await db.put({ latitude: 40.7306, longitude: -73.9352, name: "Node B" });
      // await db.put({ latitude: 40.6501, longitude: -73.9496, name: "Node C" });
      // await db.put({ latitude: 40.8404, longitude: -73.8688, name: "Node D" });
    }

    // Get the user's current location
    function getCurrentLocation() {
      return new Promise((resolve, reject) => {
        if (!navigator.geolocation) {
          reject("Geolocation is not available in this browser.");
        }
        navigator.geolocation.getCurrentPosition(
          (position) => resolve(position),
          (error) => reject(error.message)
        );
      });
    }

    // Display the location on the map using Leaflet
    function displayMap(latitude, longitude, name = "You are here.") {
      const map = L.map('map').setView([latitude, longitude], 12);
      L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: 'Â© OpenStreetMap contributors'
      }).addTo(map);
      L.marker([latitude, longitude])
        .addTo(map)
        .bindPopup(name)
        .openPopup();
    }

    // Find nearby nodes using the $near operator
    async function findNearbyNodes(latitude, longitude) {
      const { results } = await db.map();
      // {
      //   query: {
      //     location: {
      //       $near: { latitude, longitude, radius: 50 } // 50 km
      //     }
      //   }
      // }
      console.log(results);
      const resultsDiv = document.getElementById("results");
      if (results.length > 0) {
        resultsDiv.innerHTML = `<h3>Nearby nodes:</h3><ul>${results
          .map(node => `<li>${node.value.name} (${node.value.latitude}, ${node.value.longitude})</li>`)
          .join("")}</ul>`;
      } else {
        resultsDiv.innerHTML = "<p>No nearby nodes found.</p>";
      }
    }

    // Initialize the app
    async function initApp() {
      try {
        // Fill sample data
        await populateSampleData();
        // Get current location
        const position = await getCurrentLocation();
        const { latitude, longitude } = position.coords;
        // Show location
        document.getElementById("status").textContent = "Location detected.";
        document.getElementById("current-location").innerHTML = `
          <strong>Latitude:</strong> ${latitude}<br>
          <strong>Longitude:</strong> ${longitude}
        `;
        // Show map
        displayMap(latitude, longitude);
        // Find nearby nodes
        await findNearbyNodes(latitude, longitude);
      } catch (error) {
        console.error("Error:", error);
        document.getElementById("status").textContent = `Error: ${error}`;
      }
    }
    // Start the app
    initApp();
  </script>
</body>

</html>