<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GenosDB - Interactive Graph Playground</title>
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; margin: 0; background-color: #f4f7f9; color: #333; }
        .container { max-width: 1200px; margin: 20px auto; display: grid; grid-template-columns: 1fr 1fr; gap: 20px; padding: 0 20px; }
        .panel { background-color: white; border-radius: 8px; padding: 20px; box-shadow: 0 2px 10px rgba(0,0,0,0.05); }
        .full-width { grid-column: 1 / -1; }
        h1, h2 { color: #1a253c; border-bottom: 2px solid #eef2f5; padding-bottom: 10px; }
        h1 { text-align: center; }
        form { display: flex; flex-direction: column; gap: 10px; }
        input, select, button, textarea { padding: 10px; border-radius: 5px; border: 1px solid #ccc; font-size: 16px; font-family: inherit; }
        textarea { font-family: "Courier New", Courier, monospace; resize: vertical; background-color: #f8f9fa; line-height: 1.5; }
        button { background-color: #007bff; color: white; font-weight: bold; cursor: pointer; border: none; transition: background-color 0.2s; }
        button:hover { background-color: #0056b3; }
        button.danger { background-color: #dc3545; }
        button.danger:hover { background-color: #c82333; }
        pre { margin: 0; background-color: #eef2f5; padding: 15px; border-radius: 5px; white-space: pre-wrap; word-wrap: break-word; font-family: "Courier New", Courier, monospace; }
        ul { list-style-type: none; padding: 0; max-height: 300px; overflow-y: auto; }
        li { background-color: #f8f9fa; margin-bottom: 8px; padding: 10px; border-radius: 5px; border: 1px solid #e9ecef; }
        li code { background: #dde; padding: 2px 4px; border-radius: 3px; font-size: 0.8em;}
        #log { max-height: 400px; overflow-y: auto; }
        #query-result li { padding: 0; border: 1px solid #c3e6cb; background-color: #d4edda; }
        #query-result li pre { background-color: transparent; padding: 10px; }
    </style>
</head>
<body>

    <div class="container">
        <div class="panel full-width">
            <h1>ðŸ§ª GenosDB - Interactive Graph Playground</h1>
            <p>A hands-on demo to create nodes, link them, and run powerful graph traversal queries using the new <strong><code>$edge</code></strong> operator.</p>
        </div>

        <div class="panel">
            <h2>Step 1: Add Nodes</h2>
            <form id="add-node-form">
                <select id="node-type">
                    <option value="User">User</option>
                    <option value="Post">Post</option>
                    <option value="Tag">Tag</option>
                </select>
                <input type="text" id="node-name" placeholder="Name or Title" required>
                <button type="submit">Add Node</button>
            </form>
        </div>

        <div class="panel">
            <h2>Step 2: Link Nodes</h2>
            <form id="link-form">
                <select id="source-id" required><option value="">Select a Source Node</option></select>
                <select id="target-id" required><option value="">Select a Target Node</option></select>
                <button type="submit">Create Link (Source â†’ Target)</button>
            </form>
            <button id="clear-db" class="danger" style="width:100%; margin-top:10px;">Clear & Reset DB</button>
        </div>

        <div class="panel full-width">
            <h2>Step 3: View Current Graph Data (Real-time)</h2>
            <ul id="live-data-list"></ul>
        </div>

        <div class="panel" id="query-panel">
            <h2>Step 4: Run a Graph Traversal Query</h2>
            <p>Edit the query to explore the graph. The default query finds all tags from posts written by 'Ana'.</p>
            <textarea id="query-textarea" rows="12"></textarea>
            <button id="run-query">Run Query</button>
            <h3>Results:</h3>
            <ul id="query-result"></ul>
        </div>

        <div class="panel">
            <h2>Activity Log</h2>
            <pre id="log"></pre>
        </div>
    </div>

    <script type="module">
        import { GDB } from "../dist/index.js";

        const db = new GDB('graph-playground-db');

        const logEl = document.getElementById('log');
        const liveDataListEl = document.getElementById('live-data-list');
        const queryResultEl = document.getElementById('query-result');
        const sourceIdSelect = document.getElementById('source-id');
        const targetIdSelect = document.getElementById('target-id');
        const queryTextarea = document.getElementById('query-textarea');
        const queryPanel = document.getElementById('query-panel');

        function logMessage(message) {
            const time = new Date().toLocaleTimeString();
            logEl.innerHTML = `[${time}] ${message}\n` + logEl.innerHTML;
        }

        // Real-time UI update
        await db.map(({ id, value, action, edges }) => {
            const existingLi = document.getElementById(id);
            const existingSourceOpt = document.querySelector(`#source-id option[value="${id}"]`);
            const existingTargetOpt = document.querySelector(`#target-id option[value="${id}"]`);

            if (action === 'removed') {
                if (existingLi) existingLi.remove();
                if (existingSourceOpt) existingSourceOpt.remove();
                if (existingTargetOpt) existingTargetOpt.remove();
                return;
            }

            const liContent = `<b>${value.type}:</b> ${value.name} <br>
                               <small>ID: <code>${id}</code></small><br>
                               <small>Links: ${edges.length}</small>`;

            if (existingLi) {
                existingLi.innerHTML = liContent;
            } else {
                const li = document.createElement('li');
                li.id = id;
                li.innerHTML = liContent;
                liveDataListEl.appendChild(li);
            }
            
            const option = `<option value="${id}">${value.type}: ${value.name}</option>`;
            if (!existingSourceOpt) sourceIdSelect.innerHTML += option;
            if (!existingTargetOpt) targetIdSelect.innerHTML += option;
        });
        
        // Form handlers
        document.getElementById('add-node-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const type = document.getElementById('node-type').value;
            const name = document.getElementById('node-name').value;
            await db.put({ type, name });
            logMessage(`${type} '${name}' added.`);
            e.target.reset();
        });

        document.getElementById('link-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const sourceId = sourceIdSelect.value;
            const targetId = targetIdSelect.value;
            if (!sourceId || !targetId) {
                alert('Please select a Source and a Target node.');
                return;
            }
            await db.link(sourceId, targetId);
            logMessage(`Link created.`);
        });
        
        // Query logic
        const defaultQuery = {
            // 1. Start from this node
            type: 'User',
            name: 'Ana',
            
            // 2. Explore its descendants...
            $edge: {
                // 3. ...and return the ones that match this filter.
                // This will find the tags of Ana's posts.
                type: 'Tag'
            }
        };
        queryTextarea.value = JSON.stringify(defaultQuery, null, 2);

        document.getElementById('run-query').addEventListener('click', async () => {
            let query;
            try {
                query = JSON.parse(queryTextarea.value);
            } catch (error) {
                alert(`Invalid JSON in query textarea: ${error.message}`);
                logMessage(`ERROR: Invalid JSON in query. ${error.message}`);
                return;
            }
            
            logMessage("Running graph traversal query...");
            const { results } = await db.map({ query });
            
            console.log("Query results found:", results);

            queryResultEl.innerHTML = '';
            if (results.length === 0) {
                queryResultEl.innerHTML = '<li>No results found.</li>';
                logMessage("Query finished. No results.");
            } else {
                results.forEach(node => {
                    const li = document.createElement('li');
                    li.innerHTML = `<pre><code>${JSON.stringify(node, null, 2)}</code></pre>`;
                    queryResultEl.appendChild(li);
                });
                logMessage(`Query finished. Found ${results.length} item(s).`);
            }
            
            queryPanel.scrollIntoView({ behavior: 'smooth', block: 'start' });
        });

        // Seeding logic
        async function seedData() {
            await db.clear();
            logMessage("Database cleared. Seeding sample data...");

            // Create Users
            const userAna = await db.put({ type: 'User', name: 'Ana' });
            const userBob = await db.put({ type: 'User', name: 'Bob' });

            // Create Posts
            const post1 = await db.put({ type: 'Post', name: 'Intro to GenosDB' });
            const post2 = await db.put({ type: 'Post', name: 'Advanced Queries' });
            const post3 = await db.put({ type: 'Post', name: 'P2P Networking' });

            // Create Tags
            const tagDB = await db.put({ type: 'Tag', name: 'database' });
            const tagP2P = await db.put({ type: 'Tag', name: 'p2p' });
            const tagJS = await db.put({ type: 'Tag', name: 'javascript' });

            // Create Links (Ana writes 2 posts, Bob writes 1)
            await db.link(userAna, post1); // Ana -> Post 1
            await db.link(userAna, post2); // Ana -> Post 2
            await db.link(userBob, post3); // Bob -> Post 3
            
            // Tag the posts
            await db.link(post1, tagDB);    // Post 1 -> Tag 'database'
            await db.link(post1, tagJS);    // Post 1 -> Tag 'javascript'
            await db.link(post2, tagDB);    // Post 2 -> Tag 'database'
            await db.link(post3, tagP2P);   // Post 3 -> Tag 'p2p'
            
            logMessage("Sample graph created.");
        }

        document.getElementById('clear-db').addEventListener('click', () => {
             if (confirm('Are you sure you want to clear the entire database and re-seed?')) {
                seedData();
            }
        });

        const { results: initialNodes } = await db.map({ query: {} });
        if (initialNodes.length === 0) {
            await seedData();
        }
    </script>
</body>
</html>