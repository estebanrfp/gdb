<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ChatRBAC</title>
    <style>
        body {
            font-family: system-ui, sans-serif;
            margin: 0;
            background: #f5f5f5;
            display: flex;
            align-items: center;
            justify-content: center;
            min-height: 100vh;
        }

        .chat {
            width: 420px;
            background: white;
            border: 1px solid #ddd;
            border-radius: 8px;
            padding: 28px;
        }

        h1 {
            text-align: center;
            margin: 0 0 16px 0;
            font-size: 20px;
        }

        .auth,
        .room {
            margin-bottom: 24px;
        }

        textarea {
            width: 100%;
            padding: 8px;
            border: 1px solid #ccc;
            border-radius: 4px;
            resize: none;
            box-sizing: border-box;
            flex: 1;
        }

        button {
            background: #007bff;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 4px;
            cursor: pointer;
            height: 44px;
            box-sizing: border-box;
        }

        button:hover {
            background: #0056b3;
        }

        button.secondary {
            background: #6c757d;
        }

        button.secondary:hover {
            background: #545b62;
        }

        .messages {
            height: 200px;
            border: 1px solid #eee;
            padding: 10px;
            overflow-y: auto;
            margin: 16px 0;
            background: #fafafa;
        }

        .message {
            margin-bottom: 12px;
            padding: 4px 0;
        }

        .message .sender {
            font-size: 11px;
            color: #666;
            margin-bottom: 2px;
            font-weight: 500;
        }

        .message.own {
            text-align: right;
        }

        .message .text {
            display: inline-block;
            background: #e3f2fd;
            padding: 8px 12px;
            border-radius: 18px;
            max-width: 75%;
            margin: 2px 0;
            box-shadow: 0 1px 2px rgba(0, 0, 0, 0.1);
            word-wrap: break-word;
            position: relative;
        }

        .message.own .text {
            background: #007bff;
            color: white;
            box-shadow: 0 1px 2px rgba(0, 0, 0, 0.15);
        }

        .message.other .text {
            background: #f8f9fa;
            border: 1px solid #e9ecef;
        }

        .message .delete-btn {
            display: none;
            background: #dc3545;
            color: white;
            border: none;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            font-size: 14px;
            font-weight: bold;
            cursor: pointer;
            margin-left: 8px;
            vertical-align: middle;
            transition: all 0.2s ease;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.2);
        }

        .message:hover .delete-btn {
            display: inline-block;
        }

        .message .delete-btn:hover {
            background: #c82333;
            transform: scale(1.1);
        }

        .input-group {
            display: flex;
            gap: 8px;
            margin-top: 16px;
            align-items: flex-end;
        }

        .input-group textarea {
            flex: 1;
            margin-bottom: 0;
            height: 44px;
            box-sizing: border-box;
        }

        .button-group {
            display: flex;
            flex-direction: row;
            gap: 8px;
            flex-wrap: wrap;
            margin-top: 16px;
        }

        .button-group button {
            flex: 1;
            min-width: 120px;
            height: 44px;
            box-sizing: border-box;
        }

        .hidden {
            display: none;
        }

        .warning-message {
            background-color: #fff3cd;
            color: #856404;
            padding: 12px;
            border-radius: 6px;
            border: 1px solid #ffeaa7;
            font-size: 14px;
            font-weight: 500;
            margin-top: .5rem;
            margin-bottom: 12px;
            text-align: center;
        }

        .status {
            font-size: 12px;
            color: #666;
            text-align: center;
            margin-top: 16px;
            padding: 8px 0;
            border-top: 1px solid #eee;
            font-weight: 500;
        }
    </style>
</head>

<body>
    <div class="chat">
        <h1>ChatRBAC</h1>

        <!-- AUTH VIEW -->
        <div id="authSection" class="auth">
            <textarea id="mnemonicArea" placeholder="Enter recovery phrase or generate new identity"
                rows="3"></textarea>

            <div id="warningMessage" class="warning-message hidden">
                <strong>⚠️ SAVE THIS PHRASE SECURELY!</strong><br>
                This is your only way to recover your account. Store it in a password manager.
            </div>

            <div id="identityDisplay" class="hidden" style="margin-top: 12px; text-align: center;">
                <span id="generatedAddress">Generating...</span>
            </div>

            <div class="button-group">
                <button id="btnGenerateIdentity">Generate New</button>
                <button id="btnMnemonicLogin" class="secondary">Login</button>
                <button id="btnCopyPhrase" class="secondary hidden">Copy Phrase</button>
                <button id="btnWebAuthnLogin" class="secondary hidden">Use Passkey</button>
                <button id="btnProtectPasskey" class="secondary hidden">Protect with Passkey</button>
            </div>
        </div>

        <!-- CHAT VIEW -->
        <div id="chatSection" class="room hidden">
            <div class="messages" id="messagesContainer"></div>

            <div class="input-group">
                <textarea id="inputMessage" placeholder="Type message..." rows="1"></textarea>
                <button id="btnSendMessage">Send</button>
            </div>

            <div class="button-group">
                <button id="btnClearMessages" class="secondary" title="Only managers can delete all messages">Clear All
                    (Manager)</button>
                <button id="btnLogout" class="secondary">Logout</button>
            </div>
        </div>

        <div id="statusBar" class="status">Initializing...</div>
    </div>

    <script type="module">
        import { gdb } from "../dist/index.js";

        // Minimal configuration
        const SUPERADMIN_ADDRESSES = ["0xE5639DfE345F8ab845bEBE63a1C7322F9c6fF5c7"];

        // Simplified DOM references
        const elements = {
            authSection: document.getElementById('authSection'),
            chatSection: document.getElementById('chatSection'),
            statusBar: document.getElementById('statusBar'),
            mnemonicArea: document.getElementById('mnemonicArea'),
            warningMessage: document.getElementById('warningMessage'),
            identityDisplay: document.getElementById('identityDisplay'),
            generatedAddress: document.getElementById('generatedAddress'),
            btnCopyPhrase: document.getElementById('btnCopyPhrase'),
            btnGenerateIdentity: document.getElementById('btnGenerateIdentity'),
            btnMnemonicLogin: document.getElementById('btnMnemonicLogin'),
            btnWebAuthnLogin: document.getElementById('btnWebAuthnLogin'),
            btnProtectPasskey: document.getElementById('btnProtectPasskey'),
            messagesContainer: document.getElementById('messagesContainer'),
            inputMessage: document.getElementById('inputMessage'),
            btnSendMessage: document.getElementById('btnSendMessage'),
            btnClearMessages: document.getElementById('btnClearMessages'),
            btnLogout: document.getElementById('btnLogout')
        };

        // Simple state
        let db;
        let currentUserAddress = null;
        let unsubscribeMessages = null;

        // Minimal initialization
        elements.statusBar.textContent = "Initializing...";

        db = await gdb("rbacChatAppDB", {
            rtc: true,
            sm: {
                superAdmins: SUPERADMIN_ADDRESSES,
            }
        });

        function updateUI(state) {
            elements.authSection.classList.toggle('hidden', state.isActive);
            elements.chatSection.classList.toggle('hidden', !state.isActive);

            if (state.isActive) {
                // Chat view
                currentUserAddress = state.activeAddress;
                loadMessages();
            } else {
                // Auth view
                const inRegistrationFlow = state.hasVolatileIdentity;
                elements.mnemonicArea.readOnly = inRegistrationFlow;

                elements.btnGenerateIdentity.classList.toggle('hidden', inRegistrationFlow);
                elements.btnCopyPhrase.classList.toggle('hidden', !inRegistrationFlow);
                elements.warningMessage.classList.toggle('hidden', !inRegistrationFlow);
                elements.btnProtectPasskey.classList.toggle('hidden', !inRegistrationFlow);
                elements.identityDisplay.classList.toggle('hidden', !inRegistrationFlow);
                elements.btnWebAuthnLogin.classList.toggle('hidden', !state.hasWebAuthnHardwareRegistration);

                if (inRegistrationFlow) {
                    const mnemonic = db.sm.getMnemonicForDisplayAfterRegistrationOrRecovery();
                    if (mnemonic) {
                        elements.mnemonicArea.value = mnemonic;
                        elements.generatedAddress.textContent = state.activeAddress;
                        // The state change callback will update the address when available
                    }
                } else {
                    elements.mnemonicArea.value = '';
                    elements.generatedAddress.textContent = '';
                }
            }

            elements.statusBar.textContent = state.isActive ?
                `Connected as ${state.abbrAddr}` : 'Ready to login';
        }

        // Simplified callback
        db.sm.setSecurityStateChangeCallback(updateUI);

        // Simplified event handlers
        elements.btnGenerateIdentity.onclick = async () => {
            try {
                const newIdentity = await db.sm.startNewUserRegistration();
                if (newIdentity && newIdentity.address) {
                    // Update the generated address immediately
                    elements.generatedAddress.textContent = newIdentity.address;
                }
            } catch (error) {
                alert(`Error: ${error.message}`);
            }
        };

        elements.btnCopyPhrase.onclick = async () => {
            try {
                await navigator.clipboard.writeText(elements.mnemonicArea.value);
                const originalText = elements.btnCopyPhrase.textContent;
                elements.btnCopyPhrase.textContent = 'Copied!';

                // Use Promise with setTimeout for better practice
                await new Promise(resolve => setTimeout(resolve, 2000));
                elements.btnCopyPhrase.textContent = originalText;
            } catch (error) {
                alert('Error copying to clipboard');
            }
        };

        elements.btnMnemonicLogin.onclick = async () => {
            const mnemonic = elements.mnemonicArea.value.trim();
            if (!mnemonic) {
                alert('Please enter a recovery phrase');
                return;
            }
            try {
                await db.sm.loginOrRecoverUserWithMnemonic(mnemonic);
            } catch (error) {
                alert(`Login error: ${error.message}`);
            }
        };

        elements.btnWebAuthnLogin.onclick = async () => {
            try {
                await db.sm.loginCurrentUserWithWebAuthn();
            } catch (error) {
                if (error.name !== 'NotAllowedError') {
                    alert(`Passkey error: ${error.message}`);
                }
            }
        };

        elements.btnProtectPasskey.onclick = async () => {
            try {
                await db.sm.protectCurrentIdentityWithWebAuthn();
            } catch (error) {
                if (error.name !== 'NotAllowedError') {
                    alert(`Passkey error: ${error.message}`);
                }
            }
        };

        elements.btnLogout.onclick = async () => {
            try {
                await db.sm.clearSecurity();
            } catch (error) {
                alert(`Logout error: ${error.message}`);
            }
        };

        elements.btnClearMessages.onclick = async () => {
            try {
                // Verify permissions using the SM RBAC system
                await db.sm.executeWithPermission('deleteAny');
            } catch (error) {
                alert('You need superadmin permissions to clear all messages');
                return;
            }

            if (!confirm('Are you sure you want to delete ALL messages? This action cannot be undone.')) {
                return;
            }

            try {
                // Cancel current subscription
                if (unsubscribeMessages) {
                    unsubscribeMessages();
                    unsubscribeMessages = null;
                }

                // Get all messages and delete them one by one
                const messageIds = [];
                await db.map(
                    { query: { type: 'message' } },
                    ({ id }) => messageIds.push(id)
                );

                for (const messageId of messageIds) {
                    await db.remove(messageId);
                }

                // Clear the interface and restore subscription
                elements.messagesContainer.innerHTML = '';
                loadMessages();

                alert('All messages have been deleted');
            } catch (error) {
                console.error('Error clearing messages:', error);
                alert(`Error clearing messages: ${error.message}`);
            }
        };

        // Simplified chat functions
        function displayMessage({ id, value, action }) {
            if (action === 'removed') {
                document.getElementById(`msg-${id}`)?.remove();
                return;
            }

            if (!value?.type || value.type !== 'message') return;

            let msgElement = document.getElementById(`msg-${id}`);
            if (!msgElement) {
                msgElement = document.createElement('div');
                msgElement.id = `msg-${id}`;
                msgElement.classList.add('message');
                elements.messagesContainer.appendChild(msgElement);
            }

            const isOwnMessage = value.sender === currentUserAddress;
            msgElement.className = isOwnMessage ? 'message own' : 'message other';

            const senderShort = value.sender ? db.sm.abbrAddr(value.sender) : 'Unknown';

            msgElement.innerHTML = `
                <div class="sender">${isOwnMessage ? 'You' : senderShort}</div>
                <div class="text">${value.text}${isOwnMessage ? `<button class="delete-btn" onclick="deleteMessage('${id}')">×</button>` : ''}</div>
            `;

            elements.messagesContainer.scrollTop = elements.messagesContainer.scrollHeight;
        }

        async function loadMessages() {
            if (unsubscribeMessages) unsubscribeMessages();
            elements.messagesContainer.innerHTML = '';

            try {
                const { unsubscribe } = await db.map(
                    { query: { type: 'message' }, field: 'timestamp', order: 'asc' },
                    displayMessage
                );
                unsubscribeMessages = unsubscribe;
            } catch (error) {
                console.error('Error loading messages:', error);
            }
        }

        // Global function to delete messages (available immediately)
        window.deleteMessage = async function (messageId) {
            try {
                // Get the message to verify it belongs to the current user
                const message = await db.get(messageId);

                // If the message doesn't exist, it might have been deleted by another user
                if (!message || !message.value) {
                    // It's normal for the message not to exist if deleted by another user
                    // Try to delete it anyway in case it exists in the database
                    try {
                        await db.remove(messageId);
                    } catch (removeError) {
                        // Silence deletion errors if the message no longer exists
                    }
                    return;
                }

                // Verify that the current user is the owner of the message
                if (message.value.sender !== currentUserAddress) {
                    alert('You can only delete your own messages');
                    return;
                }

                await db.remove(messageId);
            } catch (error) {
                console.error('Error deleting message:', error);
                // If there's an error, try to delete anyway
                try {
                    await db.remove(messageId);
                } catch (removeError) {
                    console.warn('Could not remove message after error:', removeError.message);
                }
            }
        };

        elements.btnSendMessage.onclick = async () => {
            const text = elements.inputMessage.value.trim();
            if (!text) return;

            try {
                const senderAddress = db.sm.getActiveEthAddress();
                if (!db.sm.isSecurityActive() || !senderAddress) {
                    alert('Please login first');
                    return;
                }

                await db.put({
                    type: 'message',
                    sender: senderAddress,
                    text: text,
                    timestamp: Date.now()
                });

                elements.inputMessage.value = '';
            } catch (error) {
                alert(`Error sending message: ${error.message}`);
            }
        };

        // Send on Enter
        elements.inputMessage.addEventListener('keydown', (e) => {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                elements.btnSendMessage.click();
            }
        });
    </script>
</body>

</html>